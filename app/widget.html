<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SideDrawer Integration</title>
    <!-- Zoho CRM SDK -->
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f5f7fa;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 30px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2c3e50;
        font-size: 28px;
        margin-bottom: 10px;
      }

      .header p {
        color: #7f8c8d;
        font-size: 14px;
      }

      .status-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #3498db;
      }

      .status-card.connected {
        border-left-color: #27ae60;
        background: #eafaf1;
      }

      .status-card.error {
        border-left-color: #e74c3c;
        background: #fadbd8;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #95a5a6;
      }

      .status-dot.connected {
        background: #27ae60;
        box-shadow: 0 0 8px rgba(39, 174, 96, 0.5);
      }

      .status-dot.error {
        background: #e74c3c;
      }

      .status-text {
        font-weight: 600;
        color: #2c3e50;
      }

      .btn {
        display: inline-block;
        padding: 12px 24px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn:hover {
        background: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.btn-success {
        background: #27ae60;
      }

      .btn.btn-success:hover {
        background: #229954;
      }

      .btn.btn-danger {
        background: #e74c3c;
      }

      .btn.btn-danger:hover {
        background: #c0392b;
      }

      .info-section {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 14px;
        color: #555;
      }

      .info-section strong {
        color: #2c3e50;
      }

      .loading {
        text-align: center;
        padding: 40px;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .error-message {
        background: #fadbd8;
        border: 1px solid #e74c3c;
        color: #c0392b;
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        font-size: 14px;
      }

      .success-message {
        background: #eafaf1;
        border: 1px solid #27ae60;
        color: #229954;
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        font-size: 14px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .token-info {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîê SideDrawer Integration</h1>
        <p>Connect your Zoho CRM with SideDrawer</p>
      </div>

      <div id="app-content">
        <div class="loading">
          <div class="spinner"></div>
          <p>Initializing connection...</p>
        </div>
      </div>
    </div>

    <script>
      // Read URL parameters for configuration
      const urlParams = new URLSearchParams(window.location.search);
      const environment = urlParams.get('environment') || urlParams.get('env') || 'sandbox';
      
      // OAuth2 Configuration (can be customized via URL parameters)
      const OAUTH_CONFIG = {
        // Environment-specific endpoints
        authorizationEndpoint: environment === 'production' 
          ? 'https://auth.sidedrawer.com/authorize'
          : 'https://auth-sbx.sidedrawersbx.com/authorize',
        tokenEndpoint: environment === 'production'
          ? 'https://auth.sidedrawer.com/oauth/token'
          : 'https://auth-sbx.sidedrawersbx.com/oauth/token',
        audience: environment === 'production'
          ? 'https://user-api.sidedrawer.com'
          : 'https://user-api-sbx.sidedrawersbx.com',
        
        // Client credentials - can be passed via URL parameters
        clientId: urlParams.get('client_id') || 'AYKueA9CuMXe7fMj8QfJM722F98NwZyA',
        clientSecret: urlParams.get('client_secret') || null, // OPTIONAL with PKCE
        
        // Redirect URI - can be passed via URL parameter
        redirectUri: urlParams.get('redirect_uri') || (window.location.origin + window.location.pathname.split('?')[0]),
        
        scope: 'openid profile email offline_access'
      };
      
      // Log configuration on startup
      console.log('üîß SideDrawer OAuth Configuration:');
      console.log('  Environment:', environment);
      console.log('  Client ID:', OAUTH_CONFIG.clientId);
      console.log('  Client Secret:', OAUTH_CONFIG.clientSecret ? 'Provided' : 'Not provided (using PKCE only)');
      console.log('  Redirect URI:', OAUTH_CONFIG.redirectUri);
      console.log('  Auth Endpoint:', OAUTH_CONFIG.authorizationEndpoint);
      console.log('  Token Endpoint:', OAUTH_CONFIG.tokenEndpoint);

      // Storage keys
      const STORAGE_KEYS = {
        refreshToken: 'sidedrawer_refresh_token', // Persistent in localStorage
        codeVerifier: 'sidedrawer_code_verifier'
      };

      const ZOHO_SESSION_KEY = 'sdSession'; // Zoho session storage key

      class SideDrawerAuth {
        constructor() {
          this.zohoInitialized = false;
          this.initZoho();
        }

        async initZoho() {
          try {
            // Initialize Zoho SDK if available
            if (typeof ZOHO !== 'undefined' && ZOHO.embeddedApp) {
              console.log('Zoho SDK detected, initializing...');
              
              // Add timeout to prevent hanging when not in Zoho CRM
              const initPromise = ZOHO.embeddedApp.init();
              const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Zoho SDK init timeout')), 3000)
              );
              
              await Promise.race([initPromise, timeoutPromise]);
              this.zohoInitialized = true;
              console.log('‚úì Zoho SDK initialized successfully');
              
              // Load Zoho configuration
              await this.loadZohoConfig();
            } else {
              console.warn('‚ö† Zoho SDK not available, using localStorage fallback');
            }
          } catch (error) {
            console.warn('‚ö† Zoho SDK initialization failed, using localStorage fallback:', error.message);
            this.zohoInitialized = false;
          } finally {
            // Set up message listener for OAuth popup callback
            window.addEventListener('message', async (event) => {
              console.log('üì® Parent received message:', event.data?.type || 'unknown');
              
              // Verify origin for security
              if (event.origin !== window.location.origin) {
                console.warn('‚ö† Ignoring message from different origin:', event.origin);
                return;
              }

              if (event.data && event.data.type === 'SIDEDRAWER_OAUTH_TOKENS') {
                console.log('‚úÖ Received OAuth tokens from popup');
                console.log('Has access_token:', !!event.data.tokens?.access_token);
                console.log('Has refresh_token:', !!event.data.tokens?.refresh_token);
                
                // Show processing message
                document.getElementById('app-content').innerHTML = `
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>Saving authentication...</p>
                  </div>
                `;
                
                try {
                  // Save the tokens
                  await this.saveTokens(event.data.tokens);
                  console.log('‚úÖ Tokens saved successfully');
                  
                  // Show connected status
                  await this.checkConnection();
                } catch (error) {
                  console.error('‚ùå Failed to save tokens:', error);
                  this.showError(`Failed to save authentication: ${error.message}`);
                }
              } else if (event.data && event.data.type === 'SIDEDRAWER_OAUTH_ERROR') {
                console.error('‚ùå OAuth error from popup:', event.data.error);
                this.showError(`Authentication failed: ${event.data.error}`);
              }
            });

            // Initialize after Zoho setup (or fallback)
            console.log('Proceeding with initialization (Zoho initialized:', this.zohoInitialized, ')');
            console.log('OAuth Redirect URI:', OAUTH_CONFIG.redirectUri);
            this.init();
          }
        }

        async loadZohoConfig() {
          try {
            // Get widget variables from Zoho CRM
            const config = await ZOHO.CRM.CONFIG.getVariables();
            
            if (config) {
              console.log('‚úì Loaded Zoho widget variables:', Object.keys(config));
              
              // Redirect URI (REQUIRED in production)
              if (config.oauth_redirect_uri && config.oauth_redirect_uri.trim()) {
                OAUTH_CONFIG.redirectUri = config.oauth_redirect_uri.trim();
                console.log('‚úì Using configured redirect URI:', OAUTH_CONFIG.redirectUri);
              } else {
                console.warn('‚ö† No redirect URI configured - using auto-detection (may not work behind proxies)');
                console.log('Current URL:', OAUTH_CONFIG.redirectUri);
              }
              
              // Client ID (REQUIRED)
              if (config.client_id && config.client_id.trim()) {
                OAUTH_CONFIG.clientId = config.client_id.trim();
                console.log('‚úì Using configured Client ID');
              } else {
                console.warn('‚ö† No Client ID configured - using default (for development only)');
              }

... (truncated for tool input size)